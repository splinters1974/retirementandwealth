<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wealth in Retirement- Wealth Planner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group input, .input-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group input:disabled, .input-group select:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }

        .toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle.active {
            background: #667eea;
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle.active .toggle-slider {
            transform: translateX(30px);
        }

        .range-container {
            margin-top: 10px;
        }

        .range-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 5px;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border-left: 5px solid #667eea;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.8rem;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .stat-card.positive {
            border-left-color: #10b981;
        }

        .stat-card.positive .value {
            color: #10b981;
        }

        .stat-card.secondary {
            border-left-color: #f59e0b;
        }

        .stat-card.secondary .value {
            color: #f59e0b;
        }

        .stat-card.info {
            border-left-color: #3b82f6;
        }

        .stat-card.info .value {
            color: #3b82f6;
        }

        .stat-card.retirement {
            border-left-color: #8b5cf6;
            background: linear-gradient(135deg, #faf5ff, #f3e8ff);
        }

        .stat-card.retirement .value {
            color: #7c3aed;
        }

        .stat-card.warning {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
        }

        .stat-card.warning .value {
            color: #dc2626;
        }

        .chart-container {
            height: 400px;
            margin: 30px 0;
            position: relative;
        }

        .chart {
            width: 100%;
            height: 100%;
        }

        .summary-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .summary-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: right;
            font-weight: 600;
        }

        .summary-table th:first-child {
            text-align: left;
            border-radius: 10px 0 0 0;
        }

        .summary-table th:last-child {
            border-radius: 0 10px 0 0;
        }

        .summary-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }

        .summary-table td:first-child {
            text-align: left;
            font-weight: 600;
        }

        .summary-table tr:hover {
            background: #f8f9fa;
        }

        .summary-table .category-row {
            background: white;
        }

        .summary-table .total-row {
            background: #e0e7ff;
            font-weight: bold;
            border-top: 2px solid #667eea;
        }

        .summary-table .released-equity-row {
            background: #fef3c7;
            color: #92400e;
        }

        .summary-table .released-equity-row td:first-child {
            padding-left: 30px;
            font-style: italic;
        }

        .summary-table .state-pension-row {
            background: #dbeafe;
            color: #1e40af;
        }

        .summary-table .state-pension-row td:first-child {
            padding-left: 30px;
            font-style: italic;
        }

        .summary-table .retained-property-row {
            background: #fce7f3;
            color: #9d174d;
        }

        .summary-table .retained-property-row td:first-child {
            padding-left: 30px;
            font-style: italic;
        }

        .today-value {
            color: #6b7280;
            font-size: 0.85rem;
        }

        .future-value {
            color: #667eea;
            font-weight: 600;
        }

        .category {
            background: white;
            border-radius: 15px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .category:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .category.excluded {
            opacity: 0.6;
            background: #f5f5f5;
        }

        .category-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, #f8f9fa, #ffffff);
        }

        .category.excluded .category-header {
            background: linear-gradient(to right, #f0f0f0, #f5f5f5);
        }

        .category-title {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .category-info {
            flex: 1;
        }

        .category-info h3 {
            font-size: 1.25rem;
            color: #333;
            margin-bottom: 5px;
        }

        .category-info p {
            color: #666;
            font-size: 0.875rem;
        }

        .category-values {
            display: flex;
            gap: 40px;
            text-align: right;
            margin-right: 20px;
        }

        .value-box {
            display: flex;
            flex-direction: column;
            min-width: 140px;
        }

        .value-box .label {
            font-size: 0.75rem;
            color: #999;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .value-box .amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            line-height: 1.2;
        }

        .value-box .amount.today {
            color: #6b7280;
        }

        .value-box .amount.future {
            color: #667eea;
        }

        .arrow {
            transition: transform 0.3s;
            font-size: 1.5rem;
            color: #999;
            flex-shrink: 0;
        }

        .category-details {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: none;
        }

        .category.expanded .category-details {
            display: block;
        }

        .category.expanded .arrow {
            transform: rotate(180deg);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .mini-stat {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .mini-stat-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .mini-stat-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }

        .mini-stat.positive .mini-stat-value {
            color: #10b981;
        }

        .mini-stat.accent .mini-stat-value {
            color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .secondary {
            background: #e0e0e0;
            color: #333;
        }

        .secondary:hover {
            background: #d0d0d0;
        }

        .danger {
            background: #ef4444;
        }

        .danger:hover {
            background: #dc2626;
        }

        .hidden-file {
            display: none;
        }

        .info-box {
            background: #e0e7ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #333;
        }

        .warning-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #92400e;
        }

        .success-box {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #065f46;
        }

        .danger-box {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #991b1b;
        }

        .highlight {
            background: #fef3c7;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        .state-pension-box {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #3b82f6;
        }

        .state-pension-box h3 {
            color: #1e40af;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .state-pension-box .icon {
            width: 40px;
            height: 40px;
            background: #3b82f6;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        footer {
            text-align: center;
            color: rgba(255,255,255,0.7);
            margin-top: 40px;
            padding: 20px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .button-group, .toggle-container, input[type="range"] {
                display: none;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
                break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            .stats-row {
                grid-template-columns: 1fr;
            }
            .category-values {
                flex-direction: column;
                gap: 15px;
                align-items: flex-end;
            }
            .value-box {
                min-width: auto;
            }
            .summary-table {
                font-size: 0.8rem;
            }
            .summary-table th, .summary-table td {
                padding: 8px;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container" id="reportContent">
        <div class="header">
            <h1>Wealth Horizon</h1>
            <p>Retirement Planning & Investment Tracking</p>
        </div>

        <div class="button-group">
            <button onclick="exportData()">Export JSON</button>
            <button onclick="document.getElementById('importFile').click()" class="secondary">Import JSON</button>
            <input type="file" id="importFile" class="hidden-file" accept=".json" onchange="importData(this)">
            <button onclick="generatePDF()" style="background: #10b981;">Export PDF Report</button>
            <button onclick="resetData()" class="danger">Reset</button>
        </div>

        <div class="card">
            <div class="settings-grid">
                <div class="input-group">
                    <label>Current Age</label>
                    <input type="number" id="currentAge" value="35" onchange="updateSettings()">
                </div>
                <div class="input-group">
                    <label>Retirement Age</label>
                    <input type="number" id="retirementAge" value="65" onchange="updateSettings()">
                </div>
                <div class="input-group">
                    <label>Years to Retirement</label>
                    <input type="number" id="yearsToRetirement" readonly style="background: #f0f0f0; font-weight: bold;">
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 15px; color: #333;">Property Equity Options</h3>
            <div class="input-group">
                <label>Include Property in Total Wealth?</label>
                <div class="toggle-container">
                    <div class="toggle active" id="propertyToggle" onclick="toggleProperty()">
                        <div class="toggle-slider"></div>
                    </div>
                    <span id="toggleText">Yes - Property included</span>
                </div>
            </div>
            
            <div class="input-group" style="margin-top: 20px;">
                <div class="range-label">
                    <label>Downsizing / Equity Release at Retirement</label>
                    <span id="releasePercent">0%</span>
                </div>
                <div class="range-container">
                    <input type="range" id="equityRelease" min="0" max="100" value="0" oninput="updateEquityRelease(this.value)">
                </div>
                <p style="font-size: 0.875rem; color: #666; margin-top: 5px;">
                    Percentage of property value to release into retirement pot
                </p>
            </div>

            <div id="releaseInfo" class="info-box" style="display: none;">
                At retirement: Property value <span class="highlight" id="propertyValueAtRetire">£0</span> | 
                Release <span class="highlight" id="releaseAmount">£0</span> | 
                Retain <span class="highlight" id="retainAmount">£0</span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Current Net Worth</h3>
                <div class="value" id="currentTotal">£0</div>
            </div>
            <div class="stat-card">
                <h3>Investments at Retirement</h3>
                <div class="value" id="investmentTotal" style="color: #667eea;">£0</div>
            </div>
            <div class="stat-card secondary" id="propertyCard" style="display: none;">
                <h3>Property Retained</h3>
                <div class="value" id="retainedProperty">£0</div>
            </div>
            <div class="stat-card info" id="releasedCard" style="display: none;">
                <h3>Equity Released</h3>
                <div class="value" id="releasedEquityTotal">£0</div>
            </div>
            <div class="stat-card retirement" id="monthlyIncomeCard">
                <h3>Monthly Retirement Income</h3>
                <div class="value" id="monthlyIncome">£0</div>
                <div style="font-size: 0.75rem; color: #666; margin-top: 5px;" id="incomeBreakdown">State Pension + 4% of pot</div>
            </div>
            <div class="stat-card positive">
                <h3>Total Growth</h3>
                <div class="value" id="growthPercent">0%</div>
            </div>
        </div>

        <div class="card" style="background: linear-gradient(135deg, #faf5ff, #f3e8ff); border: 2px solid #8b5cf6;">
            <h3 style="margin-bottom: 15px; color: #7c3aed;">Retirement Income Settings</h3>
            <div class="settings-grid">
                <div class="input-group">
                    <label>Withdrawal Rate (% of investment pot)</label>
                    <input type="number" id="withdrawalRate" value="4" step="0.1" min="0" max="20" onchange="updateSettings()">
                    <small style="color: #666; margin-top: 4px;">Standard recommendation: 4%</small>
                </div>
                <div class="input-group">
                    <label>Post-Retirement Growth Rate (%)</label>
                    <input type="number" id="postRetirementRate" value="4" step="0.1" min="0" max="15" onchange="updateSettings()">
                    <small style="color: #666; margin-top: 4px;">Assumed annual return after retirement</small>
                </div>
            </div>
            
            <div id="sustainabilityBox" style="margin-top: 15px;">
                <!-- Dynamic content inserted here -->
            </div>
            
            <div class="info-box" style="margin-top: 15px; font-size: 0.85rem;">
                <strong>How it works:</strong> Released equity merges into your investment pot at retirement and grows at the post-retirement rate. 
                The sustainability analysis tracks only your <em>investment pot</em> (not retained property). 
                Retained property equity is excluded from depletion calculations - you continue to own it.
            </div>
        </div>

        <div class="card">
            <h2 style="margin-bottom: 20px; color: #333;">Wealth Projection (Nominal Values)</h2>
            <div class="chart-container">
                <canvas id="chart" class="chart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2 style="margin-bottom: 20px; color: #333;">Investment Timeline Summary</h2>
            <div class="summary-table-container">
                <table class="summary-table" id="summaryTable">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Today<br><span style="font-size: 0.8rem; font-weight: normal;">Age <span id="todayAge">35</span></span></th>
                            <th>5 Years<br><span style="font-size: 0.8rem; font-weight: normal;">Age <span id="year5Age">40</span></span></th>
                            <th>10 Years<br><span style="font-size: 0.8rem; font-weight: normal;">Age <span id="year10Age">45</span></span></th>
                            <th>Retirement<br><span style="font-size: 0.8rem; font-weight: normal;">Age <span id="retireAge">65</span></span></th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="state-pension-box">
            <h3><span class="icon">SP</span> State Pension</h3>
            <p style="color: #1e40af; margin-bottom: 10px;">Assumed £250/week (£1,083/month) from retirement age</p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.75rem; color: #666; text-transform: uppercase;">Weekly</div>
                    <div style="font-size: 1.25rem; font-weight: bold; color: #1e40af;">£250</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.75rem; color: #666; text-transform: uppercase;">Monthly</div>
                    <div style="font-size: 1.25rem; font-weight: bold; color: #1e40af;">£1,083</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.75rem; color: #666; text-transform: uppercase;">Annual</div>
                    <div style="font-size: 1.25rem; font-weight: bold; color: #1e40af;">£13,000</div>
                </div>
            </div>
            <p style="font-size: 0.8rem; color: #64748b; margin-top: 15px; font-style: italic;">
                * State Pension amount is an estimate based on current full new State Pension rates. Actual amount depends on your National Insurance record.
            </p>
        </div>

        <h2 style="color: white; margin-bottom: 20px; text-align: center; margin-top: 30px;">Investment Portfolio Details</h2>
        <div id="categories"></div>

        <footer>
            <p>Data saves automatically to browser storage</p>
            <p style="margin-top: 10px; font-size: 0.875rem;">Nominal values shown - no inflation adjustment applied</p>
        </footer>
    </div>

    <script>
        // Constants
        const STATE_PENSION_WEEKLY = 250;
        const STATE_PENSION_MONTHLY = Math.round(STATE_PENSION_WEEKLY * 52 / 12);
        const STATE_PENSION_ANNUAL = STATE_PENSION_WEEKLY * 52;

        // Default data
        const defaultData = {
            currentAge: 35,
            retirementAge: 65,
            includeProperty: true,
            equityReleasePercent: 0,
            withdrawalRate: 4,
            postRetirementRate: 4,
            categories: {
                personalSavings: { title: 'Personal Savings', color: '#3b82f6', amount: 15000, rate: 4.5, contrib: 200, freq: 'monthly', desc: 'Easy access savings' },
                isaCash: { title: 'Cash ISA', color: '#10b981', amount: 25000, rate: 5.0, contrib: 500, freq: 'monthly', desc: 'Tax-free cash savings' },
                isaStocks: { title: 'Stocks & Shares ISA', color: '#8b5cf6', amount: 40000, rate: 7.0, contrib: 300, freq: 'monthly', desc: 'Tax-free investments' },
                nonIsaStocks: { title: 'General Investment Account', color: '#f59e0b', amount: 20000, rate: 7.0, contrib: 0, freq: 'monthly', desc: 'Taxable investments' },
                premiumBonds: { title: 'Premium Bonds', color: '#ec4899', amount: 10000, rate: 4.0, contrib: 100, freq: 'monthly', desc: 'NS&I prize-based savings' },
                pension: { title: 'Pension Pot', color: '#4f46e5', amount: 120000, rate: 6.0, contrib: 800, freq: 'monthly', desc: 'Workplace & private pensions' },
                property: { title: 'Property Equity', color: '#f43f5e', amount: 750000, rate: 3.0, contrib: 0, freq: 'monthly', desc: 'Real estate value', adjustable: true }
            }
        };

        let data = JSON.parse(JSON.stringify(defaultData));

        // Global variable for depletion tracking
        let depletionData = { age: null, year: null, isDepleted: false };

        // Load from localStorage
        function loadData() {
            const saved = localStorage.getItem('wealthHorizon');
            if (saved) {
                data = JSON.parse(saved);
                if (!data.withdrawalRate) data.withdrawalRate = 4;
                if (!data.postRetirementRate) data.postRetirementRate = 4;
            }
            document.getElementById('currentAge').value = data.currentAge;
            document.getElementById('retirementAge').value = data.retirementAge;
            document.getElementById('equityRelease').value = data.equityReleasePercent || 0;
            document.getElementById('releasePercent').textContent = (data.equityReleasePercent || 0) + '%';
            document.getElementById('withdrawalRate').value = data.withdrawalRate || 4;
            document.getElementById('postRetirementRate').value = data.postRetirementRate || 4;
            updateToggleUI();
            updateSettings();
        }

        // Save to localStorage
        function saveData() {
            localStorage.setItem('wealthHorizon', JSON.stringify(data));
        }

        // Format currency
        function formatCurrency(val) {
            return '£' + Math.round(val).toLocaleString();
        }

        // Calculate future value
        function calculateFV(principal, rate, contrib, years, freq) {
            const r = (rate || 0) / 100;
            const p = parseFloat(principal) || 0;
            const c = parseFloat(contrib) || 0;
            const y = parseInt(years) || 0;
            
            const annual = freq === 'monthly' ? c * 12 : freq === 'quarterly' ? c * 4 : c;
            
            if (r === 0) {
                return p + (annual * y);
            }
            
            const compoundP = p * Math.pow(1 + r, y);
            const compoundC = annual * ((Math.pow(1 + r, y) - 1) / r);
            return compoundP + compoundC;
        }

        // Toggle property inclusion
        function toggleProperty() {
            data.includeProperty = !data.includeProperty;
            updateToggleUI();
            saveData();
            calculateAll();
        }

        // Update toggle UI
        function updateToggleUI() {
            const toggle = document.getElementById('propertyToggle');
            const text = document.getElementById('toggleText');
            if (data.includeProperty) {
                toggle.classList.add('active');
                text.textContent = 'Yes - Property included';
            } else {
                toggle.classList.remove('active');
                text.textContent = 'No - Property excluded';
            }
        }

        // Update equity release percentage
        function updateEquityRelease(value) {
            data.equityReleasePercent = parseInt(value);
            document.getElementById('releasePercent').textContent = value + '%';
            saveData();
            calculateAll();
        }

        // Update settings
        function updateSettings() {
            data.currentAge = parseInt(document.getElementById('currentAge').value) || 35;
            data.retirementAge = parseInt(document.getElementById('retirementAge').value) || 65;
            data.withdrawalRate = parseFloat(document.getElementById('withdrawalRate').value) || 4;
            data.postRetirementRate = parseFloat(document.getElementById('postRetirementRate').value) || 4;
            
            const years = data.retirementAge - data.currentAge;
            document.getElementById('yearsToRetirement').value = years;
            
            document.getElementById('todayAge').textContent = data.currentAge;
            document.getElementById('year5Age').textContent = data.currentAge + 5;
            document.getElementById('year10Age').textContent = data.currentAge + 10;
            document.getElementById('retireAge').textContent = data.retirementAge;
            
            saveData();
            calculateAll();
        }

        // Calculate all projections
        function calculateAll() {
            const yearsToRetirement = data.retirementAge - data.currentAge;
            const withdrawalRate = data.withdrawalRate || 4;
            const growthRate = data.postRetirementRate || 4;
            
            let retirementPot = 0;
            let propertyAtRetirement = 0;
            let releasedEquityAmount = 0;
            let retainedEquityAmount = 0;
            
            const accumulationProjections = [];
            
            for (let y = 0; y <= yearsToRetirement; y++) {
                const yearData = { 
                    year: new Date().getFullYear() + y, 
                    age: data.currentAge + y,
                    categories: {},
                    investmentTotal: 0,
                    phase: 'accumulation'
                };
                
                for (let [key, cat] of Object.entries(data.categories)) {
                    const fv = calculateFV(cat.amount, cat.rate, cat.contrib, y, cat.freq);
                    yearData.categories[key] = fv;
                    
                    if (key === 'property') {
                        propertyAtRetirement = fv;
                        if (y === yearsToRetirement) {
                            releasedEquityAmount = fv * (data.equityReleasePercent / 100);
                            retainedEquityAmount = fv - releasedEquityAmount;
                        }
                    } else {
                        yearData.investmentTotal += fv;
                    }
                }
                
                if (y === yearsToRetirement && releasedEquityAmount > 0) {
                    yearData.investmentTotal += releasedEquityAmount;
                    yearData.categories['releasedEquity'] = releasedEquityAmount;
                    yearData.categories['retainedProperty'] = retainedEquityAmount;
                }
                
                accumulationProjections.push(yearData);
                if (y === yearsToRetirement) retirementPot = yearData.investmentTotal;
            }
            
            // Post-retirement depletion calculation
            const postRetirementProjections = [];
            let currentPot = retirementPot;
            const annualWithdrawal = retirementPot * (withdrawalRate / 100);
            let depletionYears = 0;
            const maxPostRetirementYears = 50;
            
            if (withdrawalRate > growthRate) {
                while (currentPot > 0 && depletionYears < maxPostRetirementYears) {
                    depletionYears++;
                    currentPot = currentPot * (1 + growthRate / 100) - annualWithdrawal;
                    if (currentPot < 0) currentPot = 0;
                    
                    postRetirementProjections.push({
                        year: new Date().getFullYear() + yearsToRetirement + depletionYears,
                        age: data.retirementAge + depletionYears,
                        investmentTotal: currentPot,
                        phase: 'depletion',
                        categories: { depletedPot: currentPot }
                    });
                }
                
                depletionData = {
                    age: currentPot <= 0 ? data.retirementAge + depletionYears : null,
                    isDepleted: currentPot <= 0
                };
            } else {
                for (let i = 1; i <= 30; i++) {
                    currentPot = currentPot * (1 + growthRate / 100) - annualWithdrawal;
                    postRetirementProjections.push({
                        year: new Date().getFullYear() + yearsToRetirement + i,
                        age: data.retirementAge + i,
                        investmentTotal: currentPot,
                        phase: 'sustainable',
                        categories: { growingPot: currentPot }
                    });
                }
                depletionData = { age: null, isDepleted: false };
            }
            
            const allProjections = [...accumulationProjections, ...postRetirementProjections];
            
            updateDisplay(accumulationProjections, propertyAtRetirement, releasedEquityAmount, retainedEquityAmount);
            drawChart(allProjections);
            updateSummaryTable(accumulationProjections, releasedEquityAmount, retainedEquityAmount);
        }

        // Update main display
        function updateDisplay(projections, propertyValue, releasedEquity, retainedEquity) {
            const years = data.retirementAge - data.currentAge;
            
            let currentInvestmentTotal = 0;
            let currentPropertyValue = 0;
            
            for (let [key, cat] of Object.entries(data.categories)) {
                if (key === 'property') {
                    currentPropertyValue = cat.amount;
                } else {
                    currentInvestmentTotal += cat.amount;
                }
            }
            
            const finalProjection = projections[projections.length - 1];
            const finalInvestmentTotal = finalProjection.investmentTotal;
            
            // Calculate monthly income based on withdrawal rate + state pension
            const withdrawalRate = data.withdrawalRate || 4;
            const annualWithdrawal = finalInvestmentTotal * (withdrawalRate / 100);
            const monthlyWithdrawal = annualWithdrawal / 12;
            const totalMonthlyIncome = monthlyWithdrawal + STATE_PENSION_MONTHLY;
            
            document.getElementById('currentTotal').textContent = formatCurrency(currentInvestmentTotal + (data.includeProperty ? currentPropertyValue : 0));
            document.getElementById('investmentTotal').textContent = formatCurrency(finalInvestmentTotal);
            document.getElementById('monthlyIncome').textContent = formatCurrency(totalMonthlyIncome);
            document.getElementById('incomeBreakdown').textContent = `State Pension + ${withdrawalRate}% of £${(finalInvestmentTotal/1000).toFixed(0)}k pot`;
            
            const totalGrowth = ((finalInvestmentTotal + (data.includeProperty ? retainedEquity : 0)) / Math.max(currentInvestmentTotal + (data.includeProperty ? currentPropertyValue : 0), 1) - 1) * 100;
            document.getElementById('growthPercent').textContent = totalGrowth.toFixed(0) + '%';
            
            // Show/hide property cards
            const propertyCard = document.getElementById('propertyCard');
            const releasedCard = document.getElementById('releasedCard');
            const releaseInfo = document.getElementById('releaseInfo');
            
            if (data.includeProperty && data.equityReleasePercent > 0) {
                propertyCard.style.display = 'block';
                releasedCard.style.display = 'block';
                releaseInfo.style.display = 'block';
                
                document.getElementById('retainedProperty').textContent = formatCurrency(retainedEquity);
                document.getElementById('releasedEquityTotal').textContent = formatCurrency(releasedEquity);
                document.getElementById('propertyValueAtRetire').textContent = formatCurrency(propertyValue);
                document.getElementById('releaseAmount').textContent = formatCurrency(releasedEquity);
                document.getElementById('retainAmount').textContent = formatCurrency(retainedEquity);
            } else if (data.includeProperty) {
                propertyCard.style.display = 'block';
                releasedCard.style.display = 'none';
                releaseInfo.style.display = 'none';
                document.getElementById('retainedProperty').textContent = formatCurrency(propertyValue);
            } else {
                propertyCard.style.display = 'none';
                releasedCard.style.display = 'none';
                releaseInfo.style.display = 'none';
            }
            
            // Calculate sustainability
            calculateSustainability(finalInvestmentTotal, totalMonthlyIncome);
            
            renderCategories(finalProjection, propertyValue, releasedEquity, retainedEquity);
        }

        // Calculate sustainability - ONLY tracks investment pot (excludes retained property)
        function calculateSustainability(investmentPot, monthlyIncome) {
            const withdrawalRate = data.withdrawalRate || 4;
            const growthRate = data.postRetirementRate || 4;
            const annualIncomeFromPot = investmentPot * (withdrawalRate / 100);
            
            const sustainabilityBox = document.getElementById('sustainabilityBox');
            
            // If withdrawal rate equals or less than growth rate, infinite sustainability
            if (withdrawalRate <= growthRate) {
                const growthDifference = growthRate - withdrawalRate;
                sustainabilityBox.innerHTML = `
                    <div class="success-box">
                        <h4>✓ Sustainable Indefinitely</h4>
                        <p>With a <strong>${withdrawalRate}% withdrawal rate</strong> and <strong>${growthRate}% growth rate</strong>, your investment pot will last forever.</p>
                        <p style="margin-top: 8px; font-size: 0.9rem;">
                            The portfolio grows by ${growthDifference.toFixed(1)}% annually while providing income. 
                            Your pot never depletes. <em>Retained property equity is not included in this calculation.</em>
                        </p>
                    </div>
                `;
                return;
            }
            
            // Calculate depletion
            let pot = investmentPot;
            let years = 0;
            const maxYears = 100;
            
            while (pot > 0 && years < maxYears) {
                // Grow at post-retirement rate, then withdraw
                pot = pot * (1 + growthRate / 100) - annualIncomeFromPot;
                years++;
            }
            
            const depletionAge = data.retirementAge + years;
            
            if (years >= maxYears) {
                sustainabilityBox.innerHTML = `
                    <div class="success-box">
                        <h4>✓ Very Long Duration</h4>
                        <p>At <strong>${withdrawalRate}% withdrawal</strong> with <strong>${growthRate}% growth</strong>, your portfolio lasts over 100 years.</p>
                        <p style="margin-top: 8px; font-size: 0.9rem;"><em>Retained property equity is not included in this calculation.</em></p>
                    </div>
                `;
            } else {
                sustainabilityBox.innerHTML = `
                    <div class="danger-box">
                        <h4>⚠ Depletion Warning</h4>
                        <p>At <strong>${withdrawalRate}% withdrawal</strong> with <strong>${growthRate}% growth</strong>, your investment pot will be empty in <strong>${years} years</strong> (when you reach age ${depletionAge}).</p>
                        <p style="margin-top: 8px; font-size: 0.9rem;">
                            Consider reducing withdrawal to ${growthRate}% or less for infinite sustainability. 
                            <em>Note: Retained property equity is not spent and continues to be owned by you.</em>
                        </p>
                    </div>
                `;
            }
        }

        // Update summary table
        function updateSummaryTable(projections, releasedEquity, retainedEquity) {
            const tbody = document.getElementById('summaryTableBody');
            tbody.innerHTML = '';
            
            const years = data.retirementAge - data.currentAge;
            const idx5 = Math.min(5, years);
            const idx10 = Math.min(10, years);
            const idxRetire = years;
            
            const year0 = projections[0];
            const year5 = projections[idx5];
            const year10 = projections[idx10];
            const yearRetire = projections[idxRetire];
            
            let investmentTotalToday = 0;
            let investmentTotal5 = 0;
            let investmentTotal10 = 0;
            let investmentTotalRetire = 0;
            
            // Add rows for each investment category (excluding property)
            for (let [key, cat] of Object.entries(data.categories)) {
                if (key === 'property') continue;
                
                const today = cat.amount;
                const y5 = year5.categories[key];
                const y10 = year10.categories[key];
                const retire = yearRetire.categories[key];
                
                investmentTotalToday += today;
                investmentTotal5 += y5;
                investmentTotal10 += y10;
                investmentTotalRetire += retire;
                
                const row = document.createElement('tr');
                row.className = 'category-row';
                row.innerHTML = `
                    <td style="border-left: 4px solid ${cat.color}">${cat.title}</td>
                    <td>${formatCurrency(today)}</td>
                    <td class="future-value">${formatCurrency(y5)}</td>
                    <td class="future-value">${formatCurrency(y10)}</td>
                    <td class="future-value" style="font-weight: bold;">${formatCurrency(retire)}</td>
                `;
                tbody.appendChild(row);
            }
            
            // Add released equity row if applicable (at retirement only)
            if (releasedEquity > 0) {
                const releaseRow = document.createElement('tr');
                releaseRow.className = 'released-equity-row';
                releaseRow.innerHTML = `
                    <td>↳ Released Equity (${data.equityReleasePercent}%)</td>
                    <td>—</td>
                    <td>—</td>
                    <td>—</td>
                    <td style="font-weight: bold;">${formatCurrency(releasedEquity)}</td>
                `;
                tbody.appendChild(releaseRow);
                
                investmentTotalRetire += releasedEquity;
            }
            
            // Add investment total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td>INVESTMENT TOTAL</td>
                <td>${formatCurrency(investmentTotalToday)}</td>
                <td>${formatCurrency(investmentTotal5)}</td>
                <td>${formatCurrency(investmentTotal10)}</td>
                <td style="font-size: 1.1rem;">${formatCurrency(investmentTotalRetire)}</td>
            `;
            tbody.appendChild(totalRow);
            
            // Add retained property row if included (separate from investments)
            if (data.includeProperty) {
                const propertyRetire = yearRetire.categories['property'];
                
                const propertyRow = document.createElement('tr');
                propertyRow.className = 'retained-property-row';
                propertyRow.innerHTML = `
                    <td>↳ Property Retained (${100 - data.equityReleasePercent}%)</td>
                    <td>${formatCurrency(data.categories.property.amount)}</td>
                    <td>${formatCurrency(year5.categories['property'])}</td>
                    <td>${formatCurrency(year10.categories['property'])}</td>
                    <td>${formatCurrency(retainedEquity > 0 ? retainedEquity : propertyRetire)}</td>
                `;
                tbody.appendChild(propertyRow);
            }
            
            // Add state pension row (income, not investment)
            const pensionRow = document.createElement('tr');
            pensionRow.className = 'state-pension-row';
            pensionRow.innerHTML = `
                <td>↳ State Pension (Income)</td>
                <td>—</td>
                <td>—</td>
                <td>—</td>
                <td>${formatCurrency(STATE_PENSION_ANNUAL)}/yr</td>
            `;
            tbody.appendChild(pensionRow);
        }

        // Render category cards
        function renderCategories(finalProjection, propertyValue, releasedEquity, retainedEquity) {
            const container = document.getElementById('categories');
            container.innerHTML = '';
            const years = data.retirementAge - data.currentAge;
            
            for (let [key, cat] of Object.entries(data.categories)) {
                const projected = finalProjection.categories[key];
                const annual = cat.freq === 'monthly' ? cat.contrib * 12 : cat.freq === 'quarterly' ? cat.contrib * 4 : cat.contrib;
                const totalContrib = annual * years;
                const interest = projected - cat.amount - totalContrib;
                
                const isProperty = key === 'property';
                const isExcluded = isProperty && !data.includeProperty;
                
                const year5 = calculateFV(cat.amount, cat.rate, cat.contrib, Math.min(5, years), cat.freq);
                const year10 = calculateFV(cat.amount, cat.rate, cat.contrib, Math.min(10, years), cat.freq);
                
                // For property at retirement, show RETAINED value (not total)
                const displayProjected = isProperty ? (retainedEquity > 0 ? retainedEquity : projected) : projected;
                
                const div = document.createElement('div');
                div.className = 'category ' + (isExcluded ? 'excluded' : '');
                div.innerHTML = `
                    <div class="category-header" onclick="toggleCategory('${key}')">
                        <div class="category-title">
                            <div class="icon" style="background: ${cat.color}">£</div>
                            <div class="category-info">
                                <h3>${cat.title} ${isExcluded ? '(Excluded)' : ''}</h3>
                                <p>${cat.desc}</p>
                            </div>
                        </div>
                        <div class="category-values">
                            <div class="value-box">
                                <span class="label">Today (Age ${data.currentAge})</span>
                                <span class="amount today">${formatCurrency(cat.amount)}</span>
                            </div>
                            <div class="value-box">
                                <span class="label">At Retirement (Age ${data.retirementAge})</span>
                                <span class="amount future">${formatCurrency(displayProjected)}${isProperty && releasedEquity > 0 ? ' retained' : ''}</span>
                            </div>
                        </div>
                        <div class="arrow">▼</div>
                    </div>
                    <div class="category-details" id="details-${key}">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; text-align: center;">
                            <div class="mini-stat">
                                <div class="mini-stat-label">Today</div>
                                <div class="mini-stat-value">${formatCurrency(cat.amount)}</div>
                            </div>
                            <div class="mini-stat">
                                <div class="mini-stat-label">5 Years</div>
                                <div class="mini-stat-value" style="color: #667eea;">${formatCurrency(year5)}</div>
                            </div>
                            <div class="mini-stat">
                                <div class="mini-stat-label">10 Years</div>
                                <div class="mini-stat-value" style="color: #667eea;">${formatCurrency(year10)}</div>
                            </div>
                            <div class="mini-stat">
                                <div class="mini-stat-label">Retirement</div>
                                <div class="mini-stat-value" style="color: #667eea; font-weight: bold;">${formatCurrency(displayProjected)}${isProperty && releasedEquity > 0 ? ' (retained)' : ''}</div>
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            <div class="input-group">
                                <label>Current Amount (£)</label>
                                <input type="number" value="${cat.amount}" onchange="updateCategory('${key}', 'amount', this.value)">
                            </div>
                            <div class="input-group">
                                <label>Annual Return (%)</label>
                                <input type="number" step="0.1" value="${cat.rate}" onchange="updateCategory('${key}', 'rate', this.value)">
                            </div>
                            <div class="input-group">
                                <label>Contribution (£)</label>
                                <input type="number" value="${cat.contrib}" onchange="updateCategory('${key}', 'contrib', this.value)" ${isProperty ? 'disabled' : ''} style="${isProperty ? 'background: #e5e7eb; color: #9ca3af;' : ''}">
                                ${isProperty ? '<small style="color: #9ca3af; margin-top: 4px; display: block;">Not applicable for property</small>' : ''}
                            </div>
                            <div class="input-group">
                                <label>Frequency</label>
                                <select onchange="updateCategory('${key}', 'freq', this.value)" ${isProperty ? 'disabled' : ''} style="${isProperty ? 'background: #e5e7eb; color: #9ca3af;' : ''}">
                                    <option value="monthly" ${cat.freq === 'monthly' ? 'selected' : ''}>Monthly</option>
                                    <option value="quarterly" ${cat.freq === 'quarterly' ? 'selected' : ''}>Quarterly</option>
                                    <option value="yearly" ${cat.freq === 'yearly' ? 'selected' : ''}>Yearly</option>
                                </select>
                            </div>
                        </div>
                        <div class="stats-row">
                            <div class="mini-stat">
                                <div class="mini-stat-label">Total Contributed</div>
                                <div class="mini-stat-value">${isProperty ? 'N/A' : formatCurrency(totalContrib)}</div>
                            </div>
                            <div class="mini-stat positive">
                                <div class="mini-stat-label">Interest Earned</div>
                                <div class="mini-stat-value">${isProperty ? 'N/A' : formatCurrency(interest)}</div>
                            </div>
                            <div class="mini-stat accent">
                                <div class="mini-stat-label">Growth Multiple</div>
                                <div class="mini-stat-value">${projected > 0 && cat.amount > 0 ? (projected / cat.amount).toFixed(1) + 'x' : '—'}</div>
                            </div>
                        </div>
                        ${isProperty && data.equityReleasePercent > 0 ? `
                        <div class="info-box" style="margin-top: 15px;">
                            <strong>Retirement Breakdown:</strong><br>
                            Total Property Value: ${formatCurrency(propertyValue)}<br>
                            Released to Investment Pot: ${formatCurrency(releasedEquity)}<br>
                            Retained (shown above): ${formatCurrency(retainedEquity)}
                        </div>
                        ` : ''}
                    </div>
                `;
                container.appendChild(div);
            }
        }

        // Toggle category expansion
        function toggleCategory(key) {
            const details = document.getElementById(`details-${key}`);
            const category = details.parentElement;
            category.classList.toggle('expanded');
        }

        // Update category
        function updateCategory(key, field, value) {
            if (field === 'amount' || field === 'contrib') {
                data.categories[key][field] = parseFloat(value) || 0;
            } else if (field === 'rate') {
                data.categories[key][field] = parseFloat(value) || 0;
            } else {
                data.categories[key][field] = value;
            }
            saveData();
            calculateAll();
        }

        // Draw chart
        function drawChart(projections) {
            const canvas = document.getElementById('chart');
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            
            const width = canvas.width;
            const height = canvas.height;
            const padding = 70;
            
            ctx.clearRect(0, 0, width, height);
            
            const maxValue = Math.max(...projections.map(p => p.investmentTotal));
            const retirementIndex = projections.findIndex(p => p.age === data.retirementAge);
            
            // Grid lines
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (height - 2 * padding) * (1 - i / 5);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                ctx.fillStyle = '#666';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText('£' + (maxValue * i / 5 / 1000).toFixed(0) + 'k', padding - 10, y + 4);
            }
            
            // Accumulation phase (purple)
            const accumulationPoints = projections.slice(0, retirementIndex + 1);
            
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            accumulationPoints.forEach((p, i) => {
                const x = padding + (width - 2 * padding) * (i / (projections.length - 1));
                const y = padding + (height - 2 * padding) * (1 - p.investmentTotal / maxValue);
                ctx.lineTo(x, y);
            });
            ctx.lineTo(padding + (width - 2 * padding) * (retirementIndex / (projections.length - 1)), height - padding);
            ctx.closePath();
            
            const gradAcc = ctx.createLinearGradient(0, padding, 0, height - padding);
            gradAcc.addColorStop(0, 'rgba(102, 126, 234, 0.4)');
            gradAcc.addColorStop(1, 'rgba(102, 126, 234, 0.1)');
            ctx.fillStyle = gradAcc;
            ctx.fill();
            
            // Post-retirement phase
            const postPoints = projections.slice(retirementIndex);
            if (postPoints.length > 1) {
                ctx.beginPath();
                postPoints.forEach((p, i) => {
                    const x = padding + (width - 2 * padding) * ((retirementIndex + i) / (projections.length - 1));
                    const y = padding + (height - 2 * padding) * (1 - p.investmentTotal / maxValue);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                
                const lastIdx = projections.length - 1;
                const lastX = padding + (width - 2 * padding) * (lastIdx / (projections.length - 1));
                const retireX = padding + (width - 2 * padding) * (retirementIndex / (projections.length - 1));
                ctx.lineTo(lastX, height - padding);
                ctx.lineTo(retireX, height - padding);
                ctx.closePath();
                
                const isSus = data.withdrawalRate <= data.postRetirementRate;
                const gradPost = ctx.createLinearGradient(0, padding, 0, height - padding);
                if (isSus) {
                    gradPost.addColorStop(0, 'rgba(16, 185, 129, 0.3)');
                    gradPost.addColorStop(1, 'rgba(16, 185, 129, 0.05)');
                } else {
                    gradPost.addColorStop(0, 'rgba(239, 68, 68, 0.3)');
                    gradPost.addColorStop(1, 'rgba(239, 68, 68, 0.05)');
                }
                ctx.fillStyle = gradPost;
                ctx.fill();
            }
            
            // Lines
            ctx.beginPath();
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            accumulationPoints.forEach((p, i) => {
                const x = padding + (width - 2 * padding) * (i / (projections.length - 1));
                const y = padding + (height - 2 * padding) * (1 - p.investmentTotal / maxValue);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            if (postPoints.length > 1) {
                ctx.beginPath();
                const isSus = data.withdrawalRate <= data.postRetirementRate;
                ctx.strokeStyle = isSus ? '#10b981' : '#ef4444';
                ctx.lineWidth = 3;
                ctx.setLineDash(isSus ? [] : [5, 5]);
                postPoints.forEach((p, i) => {
                    const x = padding + (width - 2 * padding) * ((retirementIndex + i) / (projections.length - 1));
                    const y = padding + (height - 2 * padding) * (1 - p.investmentTotal / maxValue);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // Points and labels
            projections.forEach((p, i) => {
                const isRetire = i === retirementIndex;
                const isDeplete = depletionData.isDepleted && p.age === depletionData.age;
                const isMajor = i % 5 === 0 || isRetire || isDeplete || i === projections.length - 1;
                
                if (isMajor) {
                    const x = padding + (width - 2 * padding) * (i / (projections.length - 1));
                    const y = padding + (height - 2 * padding) * (1 - p.investmentTotal / maxValue);
                    
                    ctx.beginPath();
                    if (isRetire) {
                        ctx.fillStyle = '#f59e0b';
                        ctx.arc(x, y, 8, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.strokeStyle = '#f59e0b';
                        ctx.setLineDash([2, 2]);
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(x, height - padding);
                        ctx.stroke();
                        ctx.setLineDash([]);
                    } else if (isDeplete) {
                        ctx.strokeStyle = '#ef4444';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.moveTo(x - 8, y - 8);
                        ctx.lineTo(x + 8, y + 8);
                        ctx.moveTo(x + 8, y - 8);
                        ctx.lineTo(x - 8, y + 8);
                        ctx.stroke();
                    } else {
                        ctx.fillStyle = i <= retirementIndex ? '#667eea' : (data.withdrawalRate <= data.postRetirementRate ? '#10b981' : '#ef4444');
                        ctx.arc(x, y, 4, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    ctx.fillStyle = isRetire ? '#f59e0b' : (isDeplete ? '#ef4444' : '#666');
                    ctx.font = (isRetire || isDeplete) ? 'bold 11px sans-serif' : '11px sans-serif';
                    ctx.textAlign = 'center';
                    const label = isRetire ? `Retire ${p.age}` : (isDeplete ? `Depleted ${p.age}` : `${p.age}`);
                    ctx.fillText(label, x, height - padding + 25);
                    
                    if (isRetire || isDeplete) {
                        ctx.fillText('£' + (p.investmentTotal / 1000).toFixed(0) + 'k', x, y - 15);
                    }
                }
            });
            
            // Legend visibility (if elements exist)
            const sustainableLegend = document.getElementById('sustainableLegend');
            const depletionLegend = document.getElementById('depletionLegend');
            if (sustainableLegend) sustainableLegend.style.display = data.withdrawalRate <= data.postRetirementRate ? 'flex' : 'none';
            if (depletionLegend) depletionLegend.style.display = data.withdrawalRate > data.postRetirementRate ? 'flex' : 'none';
        }

        // Export JSON data
        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'wealth-horizon-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
        }

        // Generate PDF Report
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Title
            doc.setFontSize(20);
            doc.setTextColor(102, 126, 234);
            doc.text('Wealth Horizon - Retirement Report', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text('Generated: ' + new Date().toLocaleDateString('en-GB'), 105, 28, { align: 'center' });
            
            // Summary Stats
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Summary', 20, 45);
            
            const years = data.retirementAge - data.currentAge;
            const currentTotal = document.getElementById('currentTotal').textContent;
            const investmentTotal = document.getElementById('investmentTotal').textContent;
            const monthlyIncome = document.getElementById('monthlyIncome').textContent;
            const withdrawalRate = data.withdrawalRate || 4;
            
            doc.setFontSize(11);
            doc.text(`Current Age: ${data.currentAge}`, 20, 55);
            doc.text(`Retirement Age: ${data.retirementAge} (${years} years)`, 20, 62);
            doc.text(`Current Net Worth: ${currentTotal}`, 20, 69);
            doc.text(`Investments at Retirement: ${investmentTotal}`, 20, 76);
            doc.text(`Monthly Retirement Income: ${monthlyIncome}`, 20, 83);
            doc.text(`Withdrawal Rate: ${withdrawalRate}%`, 20, 90);
            
            // Property details if applicable
            let yPos = 102;
            if (data.includeProperty) {
                doc.setFontSize(14);
                doc.text('Property Equity', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(11);
                const propertyValue = document.getElementById('propertyValueAtRetire').textContent;
                const releasePct = data.equityReleasePercent;
                
                doc.text(`Property Value at Retirement: ${propertyValue}`, 20, yPos);
                yPos += 7;
                doc.text(`Equity Release: ${releasePct}%`, 20, yPos);
                yPos += 7;
                
                if (releasePct > 0) {
                    const released = document.getElementById('releasedEquityTotal').textContent;
                    const retained = document.getElementById('retainedProperty').textContent;
                    doc.text(`Released to Pot: ${released}`, 20, yPos);
                    yPos += 7;
                    doc.text(`Retained: ${retained}`, 20, yPos);
                    yPos += 7;
                }
                yPos += 5;
            }
            
            // Sustainability Analysis
            if (yPos > 240) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(14);
            doc.text('Sustainability Analysis', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(11);
            const growthRate = data.postRetirementRate || 4;
            const withdrawalRatePct = data.withdrawalRate || 4;
            
            if (withdrawalRatePct <= growthRate) {
                doc.setTextColor(6, 95, 70);
                doc.text(`✓ Sustainable indefinitely`, 20, yPos);
                yPos += 7;
                doc.text(`Withdrawal rate (${withdrawalRatePct}%) ≤ Growth rate (${growthRate}%)`, 20, yPos);
                yPos += 7;
                doc.text(`Retained property excluded from depletion calculation`, 20, yPos);
                doc.setTextColor(0, 0, 0);
            } else {
                doc.setTextColor(153, 27, 27);
                let pot = parseFloat(document.getElementById('investmentTotal').textContent.replace(/[£,]/g, ''));
                const annualWithdrawal = pot * (withdrawalRatePct / 100);
                let depletionYears = 0;
                
                while (pot > 0 && depletionYears < 100) {
                    pot = pot * (1 + growthRate / 100) - annualWithdrawal;
                    depletionYears++;
                }
                
                const depletionAge = data.retirementAge + depletionYears;
                doc.text(`⚠ Pot depletes in ${depletionYears} years (age ${depletionAge})`, 20, yPos);
                yPos += 7;
                doc.text(`Withdrawal rate (${withdrawalRatePct}%) > Growth rate (${growthRate}%)`, 20, yPos);
                yPos += 7;
                doc.text(`Retained property excluded from depletion calculation`, 20, yPos);
                doc.setTextColor(0, 0, 0);
            }
            
            // Investment Categories
            yPos += 15;
            if (yPos > 240) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(14);
            doc.text('Investment Portfolio', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setFillColor(102, 126, 234);
            doc.rect(20, yPos, 170, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text('Category', 22, yPos + 5.5);
            doc.text('Today', 80, yPos + 5.5);
            doc.text('Retirement', 120, yPos + 5.5);
            doc.text('Growth', 160, yPos + 5.5);
            
            yPos += 8;
            doc.setTextColor(0, 0, 0);
            
            for (let [key, cat] of Object.entries(data.categories)) {
                if (key === 'property') continue;
                
                const today = cat.amount;
                const retire = calculateFV(cat.amount, cat.rate, cat.contrib, years, cat.freq);
                const growth = today > 0 ? ((retire / today - 1) * 100).toFixed(0) + '%' : '—';
                
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFillColor(245, 245, 245);
                doc.rect(20, yPos, 170, 7, 'F');
                doc.text(cat.title, 22, yPos + 5);
                doc.text(formatCurrency(today), 80, yPos + 5);
                doc.text(formatCurrency(retire), 120, yPos + 5);
                doc.text(growth, 160, yPos + 5);
                
                yPos += 7;
            }
            
            // State Pension
            yPos += 5;
            if (yPos > 260) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(14);
            doc.text('State Pension (Estimated)', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(11);
            doc.text(`Weekly: £${STATE_PENSION_WEEKLY}`, 20, yPos);
            yPos += 7;
            doc.text(`Monthly: £${STATE_PENSION_MONTHLY.toLocaleString()}`, 20, yPos);
            yPos += 7;
            doc.text(`Annual: £${STATE_PENSION_ANNUAL.toLocaleString()}`, 20, yPos);
            
            // Disclaimer
            yPos += 15;
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text('Disclaimer: This report provides estimates based on assumed constant growth rates.', 20, yPos);
            yPos += 5;
            doc.text('Actual returns may vary. State Pension amounts are estimates.', 20, yPos);
            yPos += 5;
            doc.text('Sustainability analysis excludes retained property equity.', 20, yPos);
            yPos += 5;
            doc.text('Please consult a qualified financial advisor before making investment decisions.', 20, yPos);
            
            // Save
            doc.save('wealth-horizon-report-' + new Date().toISOString().split('T')[0] + '.pdf');
        }

        // Import data
        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    data = JSON.parse(e.target.result);
                    if (!data.withdrawalRate) data.withdrawalRate = 4;
                    if (!data.postRetirementRate) data.postRetirementRate = 4;
                    loadData();
                    alert('Data imported successfully!');
                } catch (err) {
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // Reset data
        function resetData() {
            if (confirm('Reset all data to defaults? This cannot be undone.')) {
                data = JSON.parse(JSON.stringify(defaultData));
                loadData();
            }
        }

        // Initialize
        window.onload = function() {
            loadData();
        };

        window.onresize = function() {
            calculateAll();
        };
    </script>
</body>
</html>